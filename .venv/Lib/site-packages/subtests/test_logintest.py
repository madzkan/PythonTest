from appium.webdriver.common.mobileby import MobileBy
from selenium.webdriver.common.by import By
from src.testproject.classes import DriverStepSettings, StepSettings
from src.testproject.decorator import report_assertion_errors
from src.testproject.enums import SleepTimingType
from src.testproject.sdk.drivers import webdriver
from vardata.varstore import udid, appPackage, appActivity, dev_token, admin_name, admin_pass
import pytest


@pytest.fixture()
def driver():
    capabilities = {
        "platformName": "Android",
        "udid": f"{udid}",
        "appPackage": f"{appPackage}",
        "autoGrantPermissions": "true",
        "appActivity": f"{appActivity}",
    }
    driver = webdriver.Remote(token=f"{dev_token}",
                              project_name="Android Automations",
                              job_name="LoginTest",
                              desired_capabilities=capabilities)
    step_settings = StepSettings(timeout=15000,
                                 sleep_time=500,
                                 sleep_timing_type=SleepTimingType.Before)
    with DriverStepSettings(driver, step_settings):
        yield driver
    driver.quit()


@report_assertion_errors
def test_login(driver):
    """login testing for Android."""

    # 1. Click 'login_username_input'
    step_settings = StepSettings(timeout=15000,
                                 sleep_time=4000,
                                 sleep_timing_type=SleepTimingType.Before)
    with DriverStepSettings(driver, step_settings):
        login_username_input = driver.find_element(MobileBy.ACCESSIBILITY_ID, "login_username_input")
        login_username_input.click()

    # 2. Type 'admin' in 'login_username_input'
    step_settings = StepSettings(timeout=7086)
    with DriverStepSettings(driver, step_settings):
        login_username_input = driver.find_element(MobileBy.ACCESSIBILITY_ID, "login_username_input")
        login_username_input.send_keys(f"{admin_name}")

    # 3. Click 'login_password_input'
    login_password_input = driver.find_element(By.XPATH, "//android.widget.EditText[@content-desc = 'login_password_input']")
    login_password_input.click()

    # 4. Type '123456!' in 'login_password_input'
    login_password_input = driver.find_element(By.XPATH,"//android.widget.EditText[@content-desc = 'login_password_input']")
    login_password_input.send_keys(f"{admin_pass}")

    '''
    # (STEP DISABLED)
    # 5. Click 'ANDROID.WIDGET.IMAGEVIEW'
    android_widget_imageview = driver.find_element(By.XPATH,
    "//android.view.ViewGroup/android.view.ViewGroup[1]/android.view.ViewGroup/android.widget.ImageView")
    android_widget_imageview.click()
    '''

    # 6. Make a Swipe gesture from ('1023','1183') to ('945','466')
    driver.swipe(start_x=1023, start_y=1183, end_x=945, end_y=466, duration=300)

    # 7. Click 'Login Test'
    login_test = driver.find_element(By.XPATH, "//android.widget.TextView[@text = 'Login']")
    login_test.click()

    home = driver.find_element(By.XPATH, "//android.view.ViewGroup/android.widget.TextView[@text = 'Home']")
    assert home.is_displayed()